@ Copyright 2024-2025 Vulcalien
@
@ This program is free software: you can redistribute it and/or modify
@ it under the terms of the GNU General Public License as published by
@ the Free Software Foundation, either version 3 of the License, or
@ (at your option) any later version.
@
@ This program is distributed in the hope that it will be useful,
@ but WITHOUT ANY WARRANTY; without even the implied warranty of
@ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
@ GNU General Public License for more details.
@
@ You should have received a copy of the GNU General Public License
@ along with this program. If not, see <https://www.gnu.org/licenses/>.

.include "macros.inc"

@ LUT-based implementation of sine. Since sin(180 + x) = -sin(x), the
@ table only contains entries for angles in [0, 180].
@
@ --- Table Generation ---
@ for i = 0 to 0x8000 / SCALE:
@     x = i * SCALE * M_PI / 0x8000
@     y = sin(x) * 0x4000
@     LUT[i] = floor(y)

@ SCALE = (1 << SCALE_SHIFT)
.equ SCALE_SHIFT, 5

@ --- sin_lut --- @
.section .rodata
.align 1

@ u16 sin_lut[0x8000 / SCALE + 1]
sin_lut:
  .short 0x0000, 0x0032, 0x0064, 0x0096, 0x00c9, 0x00fb, 0x012d, 0x015f
  .short 0x0192, 0x01c4, 0x01f6, 0x0228, 0x025b, 0x028d, 0x02bf, 0x02f1
  .short 0x0323, 0x0356, 0x0388, 0x03ba, 0x03ec, 0x041e, 0x0451, 0x0483
  .short 0x04b5, 0x04e7, 0x0519, 0x054b, 0x057d, 0x05af, 0x05e1, 0x0613
  .short 0x0645, 0x0677, 0x06a9, 0x06db, 0x070d, 0x073f, 0x0771, 0x07a3
  .short 0x07d5, 0x0807, 0x0839, 0x086b, 0x089c, 0x08ce, 0x0900, 0x0932
  .short 0x0964, 0x0995, 0x09c7, 0x09f9, 0x0a2a, 0x0a5c, 0x0a8d, 0x0abf
  .short 0x0af1, 0x0b22, 0x0b54, 0x0b85, 0x0bb6, 0x0be8, 0x0c19, 0x0c4b
  .short 0x0c7c, 0x0cad, 0x0cde, 0x0d10, 0x0d41, 0x0d72, 0x0da3, 0x0dd4
  .short 0x0e05, 0x0e36, 0x0e67, 0x0e98, 0x0ec9, 0x0efa, 0x0f2b, 0x0f5c
  .short 0x0f8c, 0x0fbd, 0x0fee, 0x101f, 0x104f, 0x1080, 0x10b0, 0x10e1
  .short 0x1111, 0x1142, 0x1172, 0x11a2, 0x11d3, 0x1203, 0x1233, 0x1263
  .short 0x1294, 0x12c4, 0x12f4, 0x1324, 0x1354, 0x1383, 0x13b3, 0x13e3
  .short 0x1413, 0x1443, 0x1472, 0x14a2, 0x14d1, 0x1501, 0x1530, 0x1560
  .short 0x158f, 0x15be, 0x15ee, 0x161d, 0x164c, 0x167b, 0x16aa, 0x16d9
  .short 0x1708, 0x1737, 0x1766, 0x1794, 0x17c3, 0x17f2, 0x1820, 0x184f
  .short 0x187d, 0x18ac, 0x18da, 0x1908, 0x1937, 0x1965, 0x1993, 0x19c1
  .short 0x19ef, 0x1a1d, 0x1a4b, 0x1a79, 0x1aa6, 0x1ad4, 0x1b02, 0x1b2f
  .short 0x1b5d, 0x1b8a, 0x1bb7, 0x1be5, 0x1c12, 0x1c3f, 0x1c6c, 0x1c99
  .short 0x1cc6, 0x1cf3, 0x1d20, 0x1d4c, 0x1d79, 0x1da6, 0x1dd2, 0x1dfe
  .short 0x1e2b, 0x1e57, 0x1e83, 0x1eb0, 0x1edc, 0x1f08, 0x1f34, 0x1f5f
  .short 0x1f8b, 0x1fb7, 0x1fe2, 0x200e, 0x2039, 0x2065, 0x2090, 0x20bb
  .short 0x20e7, 0x2112, 0x213d, 0x2168, 0x2192, 0x21bd, 0x21e8, 0x2212
  .short 0x223d, 0x2267, 0x2292, 0x22bc, 0x22e6, 0x2310, 0x233a, 0x2364
  .short 0x238e, 0x23b8, 0x23e1, 0x240b, 0x2434, 0x245e, 0x2487, 0x24b0
  .short 0x24da, 0x2503, 0x252c, 0x2554, 0x257d, 0x25a6, 0x25cf, 0x25f7
  .short 0x261f, 0x2648, 0x2670, 0x2698, 0x26c0, 0x26e8, 0x2710, 0x2738
  .short 0x275f, 0x2787, 0x27af, 0x27d6, 0x27fd, 0x2824, 0x284b, 0x2872
  .short 0x2899, 0x28c0, 0x28e7, 0x290e, 0x2934, 0x295a, 0x2981, 0x29a7
  .short 0x29cd, 0x29f3, 0x2a19, 0x2a3f, 0x2a65, 0x2a8a, 0x2ab0, 0x2ad5
  .short 0x2afa, 0x2b20, 0x2b45, 0x2b6a, 0x2b8e, 0x2bb3, 0x2bd8, 0x2bfc
  .short 0x2c21, 0x2c45, 0x2c6a, 0x2c8e, 0x2cb2, 0x2cd6, 0x2cf9, 0x2d1d
  .short 0x2d41, 0x2d64, 0x2d88, 0x2dab, 0x2dce, 0x2df1, 0x2e14, 0x2e37
  .short 0x2e5a, 0x2e7c, 0x2e9f, 0x2ec1, 0x2ee3, 0x2f05, 0x2f28, 0x2f49
  .short 0x2f6b, 0x2f8d, 0x2faf, 0x2fd0, 0x2ff1, 0x3013, 0x3034, 0x3055
  .short 0x3076, 0x3096, 0x30b7, 0x30d8, 0x30f8, 0x3118, 0x3138, 0x3159
  .short 0x3179, 0x3198, 0x31b8, 0x31d8, 0x31f7, 0x3216, 0x3236, 0x3255
  .short 0x3274, 0x3293, 0x32b1, 0x32d0, 0x32ee, 0x330d, 0x332b, 0x3349
  .short 0x3367, 0x3385, 0x33a3, 0x33c1, 0x33de, 0x33fb, 0x3419, 0x3436
  .short 0x3453, 0x3470, 0x348c, 0x34a9, 0x34c6, 0x34e2, 0x34fe, 0x351a
  .short 0x3536, 0x3552, 0x356e, 0x3589, 0x35a5, 0x35c0, 0x35dc, 0x35f7
  .short 0x3612, 0x362c, 0x3647, 0x3662, 0x367c, 0x3696, 0x36b1, 0x36cb
  .short 0x36e5, 0x36fe, 0x3718, 0x3731, 0x374b, 0x3764, 0x377d, 0x3796
  .short 0x37af, 0x37c8, 0x37e0, 0x37f9, 0x3811, 0x3829, 0x3841, 0x3859
  .short 0x3871, 0x3889, 0x38a0, 0x38b7, 0x38cf, 0x38e6, 0x38fd, 0x3913
  .short 0x392a, 0x3941, 0x3957, 0x396d, 0x3983, 0x3999, 0x39af, 0x39c5
  .short 0x39da, 0x39f0, 0x3a05, 0x3a1a, 0x3a2f, 0x3a44, 0x3a59, 0x3a6d
  .short 0x3a82, 0x3a96, 0x3aaa, 0x3abe, 0x3ad2, 0x3ae6, 0x3afa, 0x3b0d
  .short 0x3b20, 0x3b34, 0x3b47, 0x3b59, 0x3b6c, 0x3b7f, 0x3b91, 0x3ba3
  .short 0x3bb6, 0x3bc8, 0x3bda, 0x3beb, 0x3bfd, 0x3c0e, 0x3c20, 0x3c31
  .short 0x3c42, 0x3c53, 0x3c63, 0x3c74, 0x3c84, 0x3c95, 0x3ca5, 0x3cb5
  .short 0x3cc5, 0x3cd4, 0x3ce4, 0x3cf3, 0x3d02, 0x3d12, 0x3d21, 0x3d2f
  .short 0x3d3e, 0x3d4d, 0x3d5b, 0x3d69, 0x3d77, 0x3d85, 0x3d93, 0x3da1
  .short 0x3dae, 0x3dbb, 0x3dc9, 0x3dd6, 0x3de2, 0x3def, 0x3dfc, 0x3e08
  .short 0x3e14, 0x3e21, 0x3e2d, 0x3e38, 0x3e44, 0x3e50, 0x3e5b, 0x3e66
  .short 0x3e71, 0x3e7c, 0x3e87, 0x3e92, 0x3e9c, 0x3ea7, 0x3eb1, 0x3ebb
  .short 0x3ec5, 0x3ece, 0x3ed8, 0x3ee1, 0x3eeb, 0x3ef4, 0x3efd, 0x3f06
  .short 0x3f0e, 0x3f17, 0x3f1f, 0x3f27, 0x3f2f, 0x3f37, 0x3f3f, 0x3f47
  .short 0x3f4e, 0x3f55, 0x3f5d, 0x3f64, 0x3f6a, 0x3f71, 0x3f78, 0x3f7e
  .short 0x3f84, 0x3f8a, 0x3f90, 0x3f96, 0x3f9c, 0x3fa1, 0x3fa6, 0x3fac
  .short 0x3fb1, 0x3fb5, 0x3fba, 0x3fbf, 0x3fc3, 0x3fc7, 0x3fcb, 0x3fcf
  .short 0x3fd3, 0x3fd7, 0x3fda, 0x3fde, 0x3fe1, 0x3fe4, 0x3fe7, 0x3fe9
  .short 0x3fec, 0x3fee, 0x3ff0, 0x3ff2, 0x3ff4, 0x3ff6, 0x3ff8, 0x3ff9
  .short 0x3ffb, 0x3ffc, 0x3ffd, 0x3ffe, 0x3ffe, 0x3fff, 0x3fff, 0x3fff
  .short 0x4000, 0x3fff, 0x3fff, 0x3fff, 0x3ffe, 0x3ffe, 0x3ffd, 0x3ffc
  .short 0x3ffb, 0x3ff9, 0x3ff8, 0x3ff6, 0x3ff4, 0x3ff2, 0x3ff0, 0x3fee
  .short 0x3fec, 0x3fe9, 0x3fe7, 0x3fe4, 0x3fe1, 0x3fde, 0x3fda, 0x3fd7
  .short 0x3fd3, 0x3fcf, 0x3fcb, 0x3fc7, 0x3fc3, 0x3fbf, 0x3fba, 0x3fb5
  .short 0x3fb1, 0x3fac, 0x3fa6, 0x3fa1, 0x3f9c, 0x3f96, 0x3f90, 0x3f8a
  .short 0x3f84, 0x3f7e, 0x3f78, 0x3f71, 0x3f6a, 0x3f64, 0x3f5d, 0x3f55
  .short 0x3f4e, 0x3f47, 0x3f3f, 0x3f37, 0x3f2f, 0x3f27, 0x3f1f, 0x3f17
  .short 0x3f0e, 0x3f06, 0x3efd, 0x3ef4, 0x3eeb, 0x3ee1, 0x3ed8, 0x3ece
  .short 0x3ec5, 0x3ebb, 0x3eb1, 0x3ea7, 0x3e9c, 0x3e92, 0x3e87, 0x3e7c
  .short 0x3e71, 0x3e66, 0x3e5b, 0x3e50, 0x3e44, 0x3e38, 0x3e2d, 0x3e21
  .short 0x3e14, 0x3e08, 0x3dfc, 0x3def, 0x3de2, 0x3dd6, 0x3dc9, 0x3dbb
  .short 0x3dae, 0x3da1, 0x3d93, 0x3d85, 0x3d77, 0x3d69, 0x3d5b, 0x3d4d
  .short 0x3d3e, 0x3d2f, 0x3d21, 0x3d12, 0x3d02, 0x3cf3, 0x3ce4, 0x3cd4
  .short 0x3cc5, 0x3cb5, 0x3ca5, 0x3c95, 0x3c84, 0x3c74, 0x3c63, 0x3c53
  .short 0x3c42, 0x3c31, 0x3c20, 0x3c0e, 0x3bfd, 0x3beb, 0x3bda, 0x3bc8
  .short 0x3bb6, 0x3ba3, 0x3b91, 0x3b7f, 0x3b6c, 0x3b59, 0x3b47, 0x3b34
  .short 0x3b20, 0x3b0d, 0x3afa, 0x3ae6, 0x3ad2, 0x3abe, 0x3aaa, 0x3a96
  .short 0x3a82, 0x3a6d, 0x3a59, 0x3a44, 0x3a2f, 0x3a1a, 0x3a05, 0x39f0
  .short 0x39da, 0x39c5, 0x39af, 0x3999, 0x3983, 0x396d, 0x3957, 0x3941
  .short 0x392a, 0x3913, 0x38fd, 0x38e6, 0x38cf, 0x38b7, 0x38a0, 0x3889
  .short 0x3871, 0x3859, 0x3841, 0x3829, 0x3811, 0x37f9, 0x37e0, 0x37c8
  .short 0x37af, 0x3796, 0x377d, 0x3764, 0x374b, 0x3731, 0x3718, 0x36fe
  .short 0x36e5, 0x36cb, 0x36b1, 0x3696, 0x367c, 0x3662, 0x3647, 0x362c
  .short 0x3612, 0x35f7, 0x35dc, 0x35c0, 0x35a5, 0x3589, 0x356e, 0x3552
  .short 0x3536, 0x351a, 0x34fe, 0x34e2, 0x34c6, 0x34a9, 0x348c, 0x3470
  .short 0x3453, 0x3436, 0x3419, 0x33fb, 0x33de, 0x33c1, 0x33a3, 0x3385
  .short 0x3367, 0x3349, 0x332b, 0x330d, 0x32ee, 0x32d0, 0x32b1, 0x3293
  .short 0x3274, 0x3255, 0x3236, 0x3216, 0x31f7, 0x31d8, 0x31b8, 0x3198
  .short 0x3179, 0x3159, 0x3138, 0x3118, 0x30f8, 0x30d8, 0x30b7, 0x3096
  .short 0x3076, 0x3055, 0x3034, 0x3013, 0x2ff1, 0x2fd0, 0x2faf, 0x2f8d
  .short 0x2f6b, 0x2f49, 0x2f28, 0x2f05, 0x2ee3, 0x2ec1, 0x2e9f, 0x2e7c
  .short 0x2e5a, 0x2e37, 0x2e14, 0x2df1, 0x2dce, 0x2dab, 0x2d88, 0x2d64
  .short 0x2d41, 0x2d1d, 0x2cf9, 0x2cd6, 0x2cb2, 0x2c8e, 0x2c6a, 0x2c45
  .short 0x2c21, 0x2bfc, 0x2bd8, 0x2bb3, 0x2b8e, 0x2b6a, 0x2b45, 0x2b20
  .short 0x2afa, 0x2ad5, 0x2ab0, 0x2a8a, 0x2a65, 0x2a3f, 0x2a19, 0x29f3
  .short 0x29cd, 0x29a7, 0x2981, 0x295a, 0x2934, 0x290e, 0x28e7, 0x28c0
  .short 0x2899, 0x2872, 0x284b, 0x2824, 0x27fd, 0x27d6, 0x27af, 0x2787
  .short 0x275f, 0x2738, 0x2710, 0x26e8, 0x26c0, 0x2698, 0x2670, 0x2648
  .short 0x261f, 0x25f7, 0x25cf, 0x25a6, 0x257d, 0x2554, 0x252c, 0x2503
  .short 0x24da, 0x24b0, 0x2487, 0x245e, 0x2434, 0x240b, 0x23e1, 0x23b8
  .short 0x238e, 0x2364, 0x233a, 0x2310, 0x22e6, 0x22bc, 0x2292, 0x2267
  .short 0x223d, 0x2212, 0x21e8, 0x21bd, 0x2192, 0x2168, 0x213d, 0x2112
  .short 0x20e7, 0x20bb, 0x2090, 0x2065, 0x2039, 0x200e, 0x1fe2, 0x1fb7
  .short 0x1f8b, 0x1f5f, 0x1f34, 0x1f08, 0x1edc, 0x1eb0, 0x1e83, 0x1e57
  .short 0x1e2b, 0x1dfe, 0x1dd2, 0x1da6, 0x1d79, 0x1d4c, 0x1d20, 0x1cf3
  .short 0x1cc6, 0x1c99, 0x1c6c, 0x1c3f, 0x1c12, 0x1be5, 0x1bb7, 0x1b8a
  .short 0x1b5d, 0x1b2f, 0x1b02, 0x1ad4, 0x1aa6, 0x1a79, 0x1a4b, 0x1a1d
  .short 0x19ef, 0x19c1, 0x1993, 0x1965, 0x1937, 0x1908, 0x18da, 0x18ac
  .short 0x187d, 0x184f, 0x1820, 0x17f2, 0x17c3, 0x1794, 0x1766, 0x1737
  .short 0x1708, 0x16d9, 0x16aa, 0x167b, 0x164c, 0x161d, 0x15ee, 0x15be
  .short 0x158f, 0x1560, 0x1530, 0x1501, 0x14d1, 0x14a2, 0x1472, 0x1443
  .short 0x1413, 0x13e3, 0x13b3, 0x1383, 0x1354, 0x1324, 0x12f4, 0x12c4
  .short 0x1294, 0x1263, 0x1233, 0x1203, 0x11d3, 0x11a2, 0x1172, 0x1142
  .short 0x1111, 0x10e1, 0x10b0, 0x1080, 0x104f, 0x101f, 0x0fee, 0x0fbd
  .short 0x0f8c, 0x0f5c, 0x0f2b, 0x0efa, 0x0ec9, 0x0e98, 0x0e67, 0x0e36
  .short 0x0e05, 0x0dd4, 0x0da3, 0x0d72, 0x0d41, 0x0d10, 0x0cde, 0x0cad
  .short 0x0c7c, 0x0c4b, 0x0c19, 0x0be8, 0x0bb6, 0x0b85, 0x0b54, 0x0b22
  .short 0x0af1, 0x0abf, 0x0a8d, 0x0a5c, 0x0a2a, 0x09f9, 0x09c7, 0x0995
  .short 0x0964, 0x0932, 0x0900, 0x08ce, 0x089c, 0x086b, 0x0839, 0x0807
  .short 0x07d5, 0x07a3, 0x0771, 0x073f, 0x070d, 0x06db, 0x06a9, 0x0677
  .short 0x0645, 0x0613, 0x05e1, 0x05af, 0x057d, 0x054b, 0x0519, 0x04e7
  .short 0x04b5, 0x0483, 0x0451, 0x041e, 0x03ec, 0x03ba, 0x0388, 0x0356
  .short 0x0323, 0x02f1, 0x02bf, 0x028d, 0x025b, 0x0228, 0x01f6, 0x01c4
  .short 0x0192, 0x015f, 0x012d, 0x00fb, 0x00c9, 0x0096, 0x0064, 0x0032
  .short 0x0000
.size sin_lut, .-sin_lut

@ --- math_sin --- @
.global math_sin
.text

@ register allocation:
@   r0 = left, result
@   r1 = angle
@   r2 = right
@   r3 = weight_r, weight_l

@ input:
@   r0 = angle : i32
@ output:
@   r0 = result : i32
BEGIN_FUNC THUMB math_sin
    @ normalize angle in range [0, 360) degrees
    lsl     r1, r0, #16
    lsr     r1, #16                     @ (r1) angle &= 0xffff

    @ retrieve LUT entries
    ldr     r0, =sin_lut
    lsl     r2, r1, #17
    lsr     r2, #(17 + SCALE_SHIFT)     @ index = (angle % 180 deg) / SCALE
    lsl     r2, #1                      @ index * 2
    add     r2, r0                      @ &sin_lut[index]
    ldrh    r0, [r2]                    @ (r0) left  = sin_lut[index]
    ldrh    r2, [r2, #2]                @ (r2) right = sin_lut[index + 1]

    @ interpolate entries: (left * weight_l + right * weight_r) / SCALE
    lsl     r3, r1, #(32 - SCALE_SHIFT)
    lsr     r3, #(32 - SCALE_SHIFT)     @ (r3) weight_r = angle % SCALE
    mul     r2, r3                      @ (r2) right *= weight_r
    neg     r3, r3
    add     r3, #(1 << SCALE_SHIFT)     @ (r3) weight_l = SCALE - weight_r
    mul     r0, r3                      @ (r0) left *= weight_l
    add     r0, r2
    lsr     r0, #SCALE_SHIFT            @ (r0) result = (left + right) / SCALE

    @ If angle > 180 deg, adjust sign of result.
    @ Since angle is in range [0, 360) deg, i.e. [0, 0xffff],
    @ if bit 15 is set, then angle >= 180 deg.
    lsr     r1, #15                     @ check bit 15 of angle
    beq     1f @ do not adjust          @ if bit 15 clear, do not adjust
    neg     r0, r0                      @ (r0) result = -result
1: @ do not adjust

    bx      lr
END_FUNC math_sin

.end
