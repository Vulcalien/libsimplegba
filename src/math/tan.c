/* Copyright 2025 Vulcalien
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */
#include <math.h>

#define SCALE 32

// Lookup table for angles between 0 and 90 degrees
//
// for i = 0 to 0x4000 / SCALE - 1:
//     x = i * SCALE * M_PI / 0x8000
//     y = tan(x) * 0x4000
//     LUT[i] = floor(y + 0.0001)
// LUT[0x4000 / SCALE] = TODO
static const u32 tan_lut[0x4000 / SCALE + 1] = {
    0x000000, 0x000032, 0x000064, 0x000096, 0x0000c9, 0x0000fb,
    0x00012d, 0x00015f, 0x000192, 0x0001c4, 0x0001f6, 0x000229,
    0x00025b, 0x00028d, 0x0002c0, 0x0002f2, 0x000324, 0x000357,
    0x000389, 0x0003bc, 0x0003ee, 0x000421, 0x000453, 0x000486,
    0x0004b8, 0x0004eb, 0x00051d, 0x000550, 0x000582, 0x0005b5,
    0x0005e8, 0x00061a, 0x00064d, 0x000680, 0x0006b3, 0x0006e6,
    0x000718, 0x00074b, 0x00077e, 0x0007b1, 0x0007e4, 0x000817,
    0x00084a, 0x00087e, 0x0008b1, 0x0008e4, 0x000917, 0x00094a,
    0x00097e, 0x0009b1, 0x0009e5, 0x000a18, 0x000a4c, 0x000a7f,
    0x000ab3, 0x000ae7, 0x000b1a, 0x000b4e, 0x000b82, 0x000bb6,
    0x000bea, 0x000c1e, 0x000c52, 0x000c86, 0x000cba, 0x000cef,
    0x000d23, 0x000d58, 0x000d8c, 0x000dc1, 0x000df5, 0x000e2a,
    0x000e5f, 0x000e93, 0x000ec8, 0x000efd, 0x000f32, 0x000f68,
    0x000f9d, 0x000fd2, 0x001007, 0x00103d, 0x001072, 0x0010a8,
    0x0010de, 0x001114, 0x00114a, 0x00117f, 0x0011b6, 0x0011ec,
    0x001222, 0x001258, 0x00128f, 0x0012c5, 0x0012fc, 0x001333,
    0x00136a, 0x0013a0, 0x0013d8, 0x00140f, 0x001446, 0x00147d,
    0x0014b5, 0x0014ec, 0x001524, 0x00155c, 0x001594, 0x0015cc,
    0x001604, 0x00163c, 0x001675, 0x0016ad, 0x0016e6, 0x00171f,
    0x001757, 0x001790, 0x0017ca, 0x001803, 0x00183c, 0x001876,
    0x0018b0, 0x0018e9, 0x001923, 0x00195d, 0x001998, 0x0019d2,
    0x001a0c, 0x001a47, 0x001a82, 0x001abd, 0x001af8, 0x001b33,
    0x001b6f, 0x001baa, 0x001be6, 0x001c22, 0x001c5e, 0x001c9a,
    0x001cd7, 0x001d13, 0x001d50, 0x001d8d, 0x001dca, 0x001e07,
    0x001e45, 0x001e82, 0x001ec0, 0x001efe, 0x001f3c, 0x001f7a,
    0x001fb9, 0x001ff8, 0x002037, 0x002076, 0x0020b5, 0x0020f4,
    0x002134, 0x002174, 0x0021b4, 0x0021f4, 0x002235, 0x002276,
    0x0022b7, 0x0022f8, 0x002339, 0x00237b, 0x0023bd, 0x0023ff,
    0x002441, 0x002483, 0x0024c6, 0x002509, 0x00254c, 0x002590,
    0x0025d4, 0x002617, 0x00265c, 0x0026a0, 0x0026e5, 0x00272a,
    0x00276f, 0x0027b5, 0x0027fa, 0x002840, 0x002887, 0x0028cd,
    0x002914, 0x00295b, 0x0029a2, 0x0029ea, 0x002a32, 0x002a7a,
    0x002ac3, 0x002b0c, 0x002b55, 0x002b9e, 0x002be8, 0x002c32,
    0x002c7d, 0x002cc7, 0x002d12, 0x002d5e, 0x002da9, 0x002df5,
    0x002e42, 0x002e8f, 0x002edc, 0x002f29, 0x002f77, 0x002fc5,
    0x003013, 0x003062, 0x0030b1, 0x003101, 0x003151, 0x0031a1,
    0x0031f2, 0x003243, 0x003294, 0x0032e6, 0x003338, 0x00338b,
    0x0033de, 0x003432, 0x003486, 0x0034da, 0x00352f, 0x003584,
    0x0035d9, 0x00362f, 0x003686, 0x0036dd, 0x003734, 0x00378c,
    0x0037e5, 0x00383e, 0x003897, 0x0038f1, 0x00394b, 0x0039a6,
    0x003a01, 0x003a5d, 0x003ab9, 0x003b16, 0x003b73, 0x003bd1,
    0x003c30, 0x003c8f, 0x003cee, 0x003d4e, 0x003daf, 0x003e10,
    0x003e72, 0x003ed5, 0x003f38, 0x003f9b, 0x004000, 0x004064,
    0x0040ca, 0x004130, 0x004197, 0x0041fe, 0x004266, 0x0042cf,
    0x004338, 0x0043a2, 0x00440d, 0x004478, 0x0044e5, 0x004551,
    0x0045bf, 0x00462d, 0x00469c, 0x00470c, 0x00477d, 0x0047ee,
    0x004860, 0x0048d3, 0x004947, 0x0049bc, 0x004a31, 0x004aa7,
    0x004b1e, 0x004b96, 0x004c0f, 0x004c89, 0x004d04, 0x004d7f,
    0x004dfb, 0x004e79, 0x004ef7, 0x004f76, 0x004ff7, 0x005078,
    0x0050fa, 0x00517d, 0x005202, 0x005287, 0x00530d, 0x005395,
    0x00541d, 0x0054a7, 0x005532, 0x0055be, 0x00564b, 0x0056d9,
    0x005768, 0x0057f9, 0x00588b, 0x00591e, 0x0059b2, 0x005a48,
    0x005adf, 0x005b77, 0x005c11, 0x005cac, 0x005d48, 0x005de6,
    0x005e85, 0x005f26, 0x005fc8, 0x00606b, 0x006111, 0x0061b7,
    0x006260, 0x006309, 0x0063b5, 0x006462, 0x006511, 0x0065c1,
    0x006673, 0x006727, 0x0067dd, 0x006895, 0x00694e, 0x006a09,
    0x006ac7, 0x006b86, 0x006c47, 0x006d0a, 0x006dcf, 0x006e97,
    0x006f60, 0x00702c, 0x0070f9, 0x0071c9, 0x00729c, 0x007370,
    0x007447, 0x007521, 0x0075fd, 0x0076db, 0x0077bc, 0x00789f,
    0x007985, 0x007a6e, 0x007b5a, 0x007c48, 0x007d3a, 0x007e2e,
    0x007f25, 0x00801f, 0x00811c, 0x00821d, 0x008320, 0x008427,
    0x008532, 0x00863f, 0x008751, 0x008865, 0x00897e, 0x008a9a,
    0x008bba, 0x008cde, 0x008e05, 0x008f31, 0x009061, 0x009195,
    0x0092ce, 0x00940b, 0x00954c, 0x009693, 0x0097de, 0x00992d,
    0x009a82, 0x009bdc, 0x009d3b, 0x009e9f, 0x00a009, 0x00a178,
    0x00a2ed, 0x00a468, 0x00a5e9, 0x00a771, 0x00a8fe, 0x00aa92,
    0x00ac2d, 0x00adce, 0x00af77, 0x00b127, 0x00b2de, 0x00b49c,
    0x00b663, 0x00b831, 0x00ba08, 0x00bbe8, 0x00bdcf, 0x00bfc0,
    0x00c1bb, 0x00c3be, 0x00c5cc, 0x00c7e3, 0x00ca05, 0x00cc31,
    0x00ce69, 0x00d0ac, 0x00d2fa, 0x00d555, 0x00d7bc, 0x00da30,
    0x00dcb1, 0x00df40, 0x00e1dd, 0x00e489, 0x00e744, 0x00ea0e,
    0x00ece9, 0x00efd5, 0x00f2d1, 0x00f5e0, 0x00f902, 0x00fc37,
    0x00ff80, 0x0102de, 0x010652, 0x0109dc, 0x010d7d, 0x011137,
    0x01150a, 0x0118f8, 0x011d01, 0x012126, 0x01256a, 0x0129cc,
    0x012e4f, 0x0132f5, 0x0137bd, 0x013cab, 0x0141bf, 0x0146fd,
    0x014c65, 0x0151fa, 0x0157be, 0x015db3, 0x0163dd, 0x016a3d,
    0x0170d7, 0x0177ae, 0x017ec5, 0x01861f, 0x018dc2, 0x0195b0,
    0x019def, 0x01a684, 0x01af73, 0x01b8c3, 0x01c27a, 0x01cc9f,
    0x01d739, 0x01e250, 0x01edee, 0x01fa1c, 0x0206e5, 0x021456,
    0x02227a, 0x023161, 0x02411b, 0x0251ba, 0x026353, 0x0275fb,
    0x0289cd, 0x029ee5, 0x02b564, 0x02cd6f, 0x02e731, 0x0302da,
    0x0320a2, 0x0340cb, 0x0363a0, 0x03897b, 0x03b2c6, 0x03dffe,
    0x0411ba, 0x0448b0, 0x0485c0, 0x04c9fd, 0x0516bf, 0x056dbc,
    0x05d123, 0x0643d2, 0x06c99c, 0x0767b6, 0x08256b, 0x090d45,
    0x0a2f12, 0x0ba3a6, 0x0d9466, 0x104bd2, 0x145eed, 0x1b2963,
    0x28be3f, 0x517cb0, // TODO last entry
};

i32 math_tan(i32 angle) {
    // normalize angle in range [-90, 90] degrees
    angle &= BITMASK(15);
    if(angle > math_brad(90))
        angle -= math_brad(180);

    // if argument is outside the domain, return 0
    if(math_abs(angle) == math_brad(90))
        return 0;

    u32 index  = math_abs(angle) / SCALE;
    u32 weight = math_abs(angle) % SCALE;

    u32 left  = tan_lut[index];
    u32 right = tan_lut[index + 1];

    // interpolate LUT entries
    i32 result = (left * (SCALE - weight) + right * weight) / SCALE;

    // adjust sign
    if(angle < 0)
        result *= -1;

    return result;
}
